{"ast":null,"code":"import Node from '../core/Node.js';\nimport { ShaderNode, attribute, buffer, mat4, uniform, positionLocal, normalLocal, tangentLocal, assign, element, add, mul, transformDirection } from '../shadernode/ShaderNodeBaseElements.js';\nimport { NodeUpdateType } from '../core/constants.js';\nconst Skinning = new ShaderNode((inputs, builder) => {\n  const {\n    index,\n    weight,\n    bindMatrix,\n    bindMatrixInverse,\n    boneMatrices\n  } = inputs;\n  const boneMatX = element(boneMatrices, index.x);\n  const boneMatY = element(boneMatrices, index.y);\n  const boneMatZ = element(boneMatrices, index.z);\n  const boneMatW = element(boneMatrices, index.w);\n\n  // POSITION\n\n  const skinVertex = mul(bindMatrix, positionLocal);\n  const skinned = add(mul(mul(boneMatX, skinVertex), weight.x), mul(mul(boneMatY, skinVertex), weight.y), mul(mul(boneMatZ, skinVertex), weight.z), mul(mul(boneMatW, skinVertex), weight.w));\n  const skinPosition = mul(bindMatrixInverse, skinned).xyz;\n\n  // NORMAL\n\n  let skinMatrix = add(mul(weight.x, boneMatX), mul(weight.y, boneMatY), mul(weight.z, boneMatZ), mul(weight.w, boneMatW));\n  skinMatrix = mul(mul(bindMatrixInverse, skinMatrix), bindMatrix);\n  const skinNormal = transformDirection(skinMatrix, normalLocal).xyz;\n\n  // ASSIGNS\n\n  assign(positionLocal, skinPosition).build(builder);\n  assign(normalLocal, skinNormal).build(builder);\n  if (builder.hasGeometryAttribute('tangent')) {\n    assign(tangentLocal, skinNormal).build(builder);\n  }\n});\nclass SkinningNode extends Node {\n  constructor(skinnedMesh) {\n    super('void');\n    this.skinnedMesh = skinnedMesh;\n    this.updateType = NodeUpdateType.OBJECT;\n\n    //\n\n    this.skinIndexNode = attribute('skinIndex', 'uvec4');\n    this.skinWeightNode = attribute('skinWeight', 'vec4');\n    this.bindMatrixNode = uniform(mat4(skinnedMesh.bindMatrix));\n    this.bindMatrixInverseNode = uniform(mat4(skinnedMesh.bindMatrixInverse));\n    this.boneMatricesNode = buffer(skinnedMesh.skeleton.boneMatrices, 'mat4', skinnedMesh.skeleton.bones.length);\n  }\n  generate(builder) {\n    Skinning.call({\n      index: this.skinIndexNode,\n      weight: this.skinWeightNode,\n      bindMatrix: this.bindMatrixNode,\n      bindMatrixInverse: this.bindMatrixInverseNode,\n      boneMatrices: this.boneMatricesNode\n    }, builder);\n  }\n  update() {\n    this.skinnedMesh.skeleton.update();\n  }\n}\nexport default SkinningNode;","map":{"version":3,"names":["Node","ShaderNode","attribute","buffer","mat4","uniform","positionLocal","normalLocal","tangentLocal","assign","element","add","mul","transformDirection","NodeUpdateType","Skinning","inputs","builder","index","weight","bindMatrix","bindMatrixInverse","boneMatrices","boneMatX","x","boneMatY","y","boneMatZ","z","boneMatW","w","skinVertex","skinned","skinPosition","xyz","skinMatrix","skinNormal","build","hasGeometryAttribute","SkinningNode","constructor","skinnedMesh","updateType","OBJECT","skinIndexNode","skinWeightNode","bindMatrixNode","bindMatrixInverseNode","boneMatricesNode","skeleton","bones","length","generate","call","update"],"sources":["C:/Users/dro1l/source/repos/StaffWork/staffwork.client/node_modules/three/examples/jsm/nodes/accessors/SkinningNode.js"],"sourcesContent":["import Node from '../core/Node.js';\nimport {\n\tShaderNode,\n\tattribute,\n\tbuffer,\n\tmat4,\n\tuniform,\n\tpositionLocal,\n\tnormalLocal,\n\ttangentLocal,\n\tassign,\n\telement,\n\tadd,\n\tmul,\n\ttransformDirection\n} from '../shadernode/ShaderNodeBaseElements.js';\n\nimport { NodeUpdateType } from '../core/constants.js';\n\nconst Skinning = new ShaderNode( ( inputs, builder ) => {\n\n\tconst { index, weight, bindMatrix, bindMatrixInverse, boneMatrices } = inputs;\n\n\tconst boneMatX = element( boneMatrices, index.x );\n\tconst boneMatY = element( boneMatrices, index.y );\n\tconst boneMatZ = element( boneMatrices, index.z );\n\tconst boneMatW = element( boneMatrices, index.w );\n\n\t// POSITION\n\n\tconst skinVertex = mul( bindMatrix, positionLocal );\n\n\tconst skinned = add(\n\t\tmul( mul( boneMatX, skinVertex ), weight.x ),\n\t\tmul( mul( boneMatY, skinVertex ), weight.y ),\n\t\tmul( mul( boneMatZ, skinVertex ), weight.z ),\n\t\tmul( mul( boneMatW, skinVertex ), weight.w )\n\t);\n\n\tconst skinPosition = mul( bindMatrixInverse, skinned ).xyz;\n\n\t// NORMAL\n\n\tlet skinMatrix = add(\n\t\tmul( weight.x, boneMatX ),\n\t\tmul( weight.y, boneMatY ),\n\t\tmul( weight.z, boneMatZ ),\n\t\tmul( weight.w, boneMatW )\n\t);\n\n\tskinMatrix = mul( mul( bindMatrixInverse, skinMatrix ), bindMatrix );\n\n\tconst skinNormal = transformDirection( skinMatrix, normalLocal ).xyz;\n\n\t// ASSIGNS\n\n\tassign( positionLocal, skinPosition ).build( builder );\n\tassign( normalLocal, skinNormal ).build( builder );\n\n\tif ( builder.hasGeometryAttribute( 'tangent' ) ) {\n\n\t\tassign( tangentLocal, skinNormal ).build( builder );\n\n\t}\n\n} );\n\nclass SkinningNode extends Node {\n\n\tconstructor( skinnedMesh ) {\n\n\t\tsuper( 'void' );\n\n\t\tthis.skinnedMesh = skinnedMesh;\n\n\t\tthis.updateType = NodeUpdateType.OBJECT;\n\n\t\t//\n\n\t\tthis.skinIndexNode = attribute( 'skinIndex', 'uvec4' );\n\t\tthis.skinWeightNode = attribute( 'skinWeight', 'vec4' );\n\n\t\tthis.bindMatrixNode = uniform( mat4( skinnedMesh.bindMatrix ) );\n\t\tthis.bindMatrixInverseNode = uniform( mat4( skinnedMesh.bindMatrixInverse ) );\n\t\tthis.boneMatricesNode = buffer( skinnedMesh.skeleton.boneMatrices, 'mat4', skinnedMesh.skeleton.bones.length );\n\n\t}\n\n\tgenerate( builder ) {\n\n\t\tSkinning.call( {\n\t\t\tindex: this.skinIndexNode,\n\t\t\tweight: this.skinWeightNode,\n\t\t\tbindMatrix: this.bindMatrixNode,\n\t\t\tbindMatrixInverse: this.bindMatrixInverseNode,\n\t\t\tboneMatrices: this.boneMatricesNode\n\t\t}, builder );\n\n\t}\n\n\tupdate() {\n\n\t\tthis.skinnedMesh.skeleton.update();\n\n\t}\n\n}\n\nexport default SkinningNode;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}